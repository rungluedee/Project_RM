import os
import time
import subprocess
import shutil

def scan_hidden_persistence():
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏ö‡∏î‡∏≤‡∏ô‡πÅ‡∏ù‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô 
    ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢ main_gui.py ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏•‡πÅ‡∏ß‡∏£‡πå‡∏°‡∏±‡∏Å‡πÅ‡∏≠‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
    """
    print(f"üïµÔ∏è [SCANNER] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡πÅ‡∏≠‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ù‡∏á (Startup & Temp)...")
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Startup ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    startup_path = os.path.expandvars(r'%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup')
    if os.path.exists(startup_path):
        suspicious_files = [f for f in os.listdir(startup_path) if f.lower().endswith(('.exe', '.vbs', '.bat'))]
        for s_file in suspicious_files:
            print(f"‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÉ‡∏ô Startup: {s_file}")
            # ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ os.remove(os.path.join(startup_path, s_file))

def run_deep_cleanup(file_list, original_input=None):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏∂‡∏Å: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Service, Registry, Tasks ‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏ö‡∏î‡∏≤‡∏ô‡πÅ‡∏ù‡∏á"""
    print(f"\nüßπ [MALWARE CLEANER] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏∂‡∏Å...")

    # 1. ‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏á‡∏à‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    for file_path in file_list:
        base_name = os.path.splitext(os.path.basename(file_path))[0]
        # ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Scheduled Tasks ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        os.system(f'schtasks /delete /tn "{base_name}" /f >nul 2>&1')
        # ‡∏•‡∏ö WMI Event
        os.system(f'powershell -Command "Get-WMIObject -Namespace root\\subscription -Class __EventFilter | Where-Object {{$_.Name -eq \'{base_name}\'}} | Remove-WmiObject" >nul 2>&1')
        # ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö Windows Service
        os.system(f'sc stop "{base_name}" >nul 2>&1')
        os.system(f'sc delete "{base_name}" >nul 2>&1')

    # 2. ‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£ Re-install ‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏ö‡∏î‡∏≤‡∏ô
    target_dirs = ["D:/project/temp_extraction", os.getenv('TEMP')]
    for t_dir in target_dirs:
        if os.path.exists(t_dir):
            try:
                shutil.rmtree(t_dir, ignore_errors=True)
                os.makedirs(t_dir)
                print(f"‚ú® ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏ö‡∏î‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {t_dir}")
            except: pass

    # 3. ‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô Registry
    registry_keys = [
        r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
        r"SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce",
        r"SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run"
    ]
    for file_path in file_list:
        base_name = os.path.splitext(os.path.basename(file_path))[0]
        for key in registry_keys:
            os.system(f'reg delete "HKCU\\{key}" /v "{base_name}" /f >nul 2>&1')
            os.system(f'reg delete "HKLM\\{key}" /v "{base_name}" /f >nul 2>&1')

    # 4. ‡∏ï‡∏≤‡∏°‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Shortcut ‡∏ö‡∏ô Desktop
    desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
    if os.path.exists(desktop_path):
        for item in os.listdir(desktop_path):
            if item.endswith(".lnk"):
                lnk_path = os.path.join(desktop_path, item)
                try:
                    cmd = f'$sh = New-Object -ComObject WScript.Shell; $sh.CreateShortcut("{lnk_path}").TargetPath'
                    target_path = subprocess.check_output(['powershell', '-Command', cmd], text=True).strip()
                    if target_path and os.path.exists(target_path):
                        target_filename = os.path.basename(target_path)
                        os.system(f"taskkill /F /IM {target_filename} /T >nul 2>&1")
                        os.chmod(target_path, 0o777)
                        os.remove(target_path)
                    os.remove(lnk_path)
                    print(f"‡∏•‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ù‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {item}")
                except: pass

    # 5. ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
    if original_input and os.path.exists(original_input):
        try:
            os.remove(original_input)
            print(f"‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Ç‡∏±‡πâ‡∏ß‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≥ 100%)")
        except: pass

    # 6. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö
    os.system("taskkill /F /IM explorer.exe >nul 2>&1 & start explorer.exe")
    print(f"‚úÖ [SUCCESS] ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏≠‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß")