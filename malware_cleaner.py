import os
import time
import subprocess
import shutil

def run_deep_cleanup(file_list, original_input=None):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏∂‡∏Å: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Service, Registry, Tasks ‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏ö‡∏î‡∏≤‡∏ô‡πÅ‡∏ù‡∏á"""
    print(f"\nüßπ [MALWARE CLEANER] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏∂‡∏Å...")

    # 1. ‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏á‡∏à‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (Phase 1)
    for file_path in file_list:
        base_name = os.path.splitext(os.path.basename(file_path))[0]
        # ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Scheduled Tasks ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏•‡πÅ‡∏ß‡∏£‡πå‡πÅ‡∏≠‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≥)
        os.system(f'schtasks /delete /tn "{base_name}" /f >nul 2>&1')
        # ‡∏•‡∏ö WMI Event (‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)
        os.system(f'powershell -Command "Get-WMIObject -Namespace root\\subscription -Class __EventFilter | Where-Object {{$_.Name -eq \'{base_name}\'}} | Remove-WmiObject" >nul 2>&1')
        # ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö Windows Service
        os.system(f'sc stop "{base_name}" >nul 2>&1')
        os.system(f'sc delete "{base_name}" >nul 2>&1')

    # 2. ‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£ Re-install ‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏ö‡∏î‡∏≤‡∏ô (Phase 2)
    # ‡∏°‡∏±‡∏Å‡πÅ‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå
    target_dirs = ["D:/project/temp_extraction", os.getenv('TEMP')]
    for t_dir in target_dirs:
        if os.path.exists(t_dir):
            try:
                shutil.rmtree(t_dir, ignore_errors=True)
                os.makedirs(t_dir)
                print(f"‚ú® ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏ö‡∏î‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {t_dir}")
            except: pass

    # 3. ‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô Registry
    registry_keys = [
        r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
        r"SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce",
        r"SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run"
    ]
    for file_path in file_list:
        base_name = os.path.splitext(os.path.basename(file_path))[0]
        for key in registry_keys:
            os.system(f'reg delete "HKCU\\{key}" /v "{base_name}" /f >nul 2>&1')
            os.system(f'reg delete "HKLM\\{key}" /v "{base_name}" /f >nul 2>&1')

    # 4. ‡∏ï‡∏≤‡∏°‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Shortcut ‡∏ö‡∏ô Desktop
    desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
    if os.path.exists(desktop_path):
        for item in os.listdir(desktop_path):
            if item.endswith(".lnk"):
                lnk_path = os.path.join(desktop_path, item)
                try:
                    cmd = f'$sh = New-Object -ComObject WScript.Shell; $sh.CreateShortcut("{lnk_path}").TargetPath'
                    target_path = subprocess.check_output(['powershell', '-Command', cmd], text=True).strip()
                    if target_path and os.path.exists(target_path):
                        target_filename = os.path.basename(target_path)
                        os.system(f"taskkill /F /IM {target_filename} /T >nul 2>&1")
                        os.chmod(target_path, 0o777)
                        os.remove(target_path)
                    os.remove(lnk_path)
                    print(f"‡∏•‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ù‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {item}")
                except: pass

    # 5. ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö 15.3 MB ‡πÉ‡∏ô Downloads
    if original_input and os.path.exists(original_input):
        try:
            os.remove(original_input)
            print(f"‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Ç‡∏±‡πâ‡∏ß‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≥ 100%)")
        except: pass

    # 6. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö
    os.system("taskkill /F /IM explorer.exe >nul 2>&1 & start explorer.exe")
    print(f"‚úÖ [SUCCESS] ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏≠‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß")